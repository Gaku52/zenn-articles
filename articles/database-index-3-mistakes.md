---
title: "DBã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã§é™¥ã‚Šã‚„ã™ã„3ã¤ã®å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³"
emoji: "ðŸ—„ï¸"
type: "tech"
topics: ["database", "postgresql", "mysql", "sql", "backend"]
published: true
---

## ã¯ã˜ã‚ã«

ã€Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è²¼ã£ãŸã®ã«é…ã„ã€
ã€Œã©ã®ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œã‚Œã°ã„ã„ã‹ã‚ã‹ã‚‰ãªã„ã€
ã€ŒN+1å•é¡Œã£ã¦èžãã‘ã©ã€ã©ã†ç›´ã›ã°ã„ã„ã®ï¼Ÿã€

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å•é¡Œã¯ã€å¤šãã®é–‹ç™ºè€…ãŒç›´é¢ã™ã‚‹èª²é¡Œã§ã™ã€‚ç‰¹ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã¯ã€é©åˆ‡ã«è¡Œãˆã°**ã‚¯ã‚¨ãƒªé€Ÿåº¦ã‚’100å€ä»¥ä¸Šæ”¹å–„**ã§ãã‚‹ä¸€æ–¹ã€èª¤ã£ãŸè¨­è¨ˆã¯å…¨ãåŠ¹æžœãŒã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ã‚ˆãã‚ã‚‹**3ã¤ã®å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³**ã¨ã€ãã®è§£æ±ºç­–ã‚’æƒ³å®šåŠ¹æžœã¨ã¨ã‚‚ã«è§£èª¬ã—ã¾ã™ã€‚

:::message
ã“ã®è¨˜äº‹ã¯ã€ç­†è€…ã®æ›¸ç±ã€Œ[Databaseè¨­è¨ˆå®Œå…¨ã‚¬ã‚¤ãƒ‰ 2026](https://zenn.dev/gaku52/books/database-design-complete-guide-2026)ã€ã‹ã‚‰ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã®åŸºç¤Žéƒ¨åˆ†ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚ã‚ˆã‚Šè©³ã—ã„å†…å®¹ï¼ˆæ­£è¦åŒ–ç†è«–ã€ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã€Prisma/TypeORMå®Ÿè·µã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãªã©ï¼‰ã¯æ›¸ç±ã§è§£èª¬ã—ã¦ã„ã¾ã™ã€‚
:::

## å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³1: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é †åºãƒŸã‚¹

### ã‚ˆãã‚ã‚‹é–“é•ã„

è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹éš›ã€ã‚«ãƒ©ãƒ ã®é †åºã‚’é©å½“ã«æ±ºã‚ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ

```sql
-- âŒ é–“é•ã„ï¼šé †åºã‚’è€ƒãˆãšã«ä½œæˆ
CREATE INDEX idx_posts_created_user ON posts(created_at, user_id);

-- ã“ã®ã‚¯ã‚¨ãƒªã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã§ããªã„ï¼
SELECT * FROM posts WHERE user_id = 123 ORDER BY created_at DESC;
-- çµæžœ: Seq Scanï¼ˆå…¨è¡Œã‚¹ã‚­ãƒ£ãƒ³ï¼‰â†’ 5,200ms
```

è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯**å·¦ç«¯ã‹ã‚‰é †ç•ªã«**ã—ã‹ä½¿ãˆã¾ã›ã‚“ã€‚`(created_at, user_id)` ã®é †åºã§ã¯ã€`user_id` å˜ä½“ã§ã®æ¤œç´¢ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãã¾ã›ã‚“ã€‚

### æ­£ã—ã„è¨­è¨ˆ

```sql
-- âœ… æ­£ã—ã„é †åº
CREATE INDEX idx_posts_user_created ON posts(user_id, created_at);

-- user_id ã§æ¤œç´¢ â†’ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨å¯èƒ½
SELECT * FROM posts WHERE user_id = 123;
-- Index Scan â†’ 15ms

-- user_id + created_at ã§æ¤œç´¢ â†’ å®Œå…¨ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨
SELECT * FROM posts WHERE user_id = 123 ORDER BY created_at DESC;
-- Index Scan â†’ 18msï¼ˆ-99.6%æ”¹å–„ï¼‰
```

### è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é †åºãƒ«ãƒ¼ãƒ«

| å„ªå…ˆåº¦ | ãƒ«ãƒ¼ãƒ« | ç†ç”± |
|--------|--------|------|
| 1 | ç­‰ä¾¡æ¡ä»¶(`=`)ã®ã‚«ãƒ©ãƒ ã‚’å…ˆã« | ç¯„å›²ã‚’çµžã‚Šè¾¼ã‚€åŠ¹æžœãŒé«˜ã„ |
| 2 | ç¯„å›²æ¡ä»¶(`>`, `<`, `BETWEEN`)ã‚’å¾Œã« | ç¯„å›²æ¤œç´¢å¾Œã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„ |
| 3 | ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒé«˜ã„é †ã« | çµžã‚Šè¾¼ã¿åŠ¹æžœã‚’æœ€å¤§åŒ– |

```sql
-- âœ… æœ€é©ãªé †åºã®ä¾‹
CREATE INDEX idx_orders_user_status_created
ON orders(user_id, status, created_at);

-- ã“ã®ã‚¯ã‚¨ãƒªã«æœ€é©åŒ–
SELECT * FROM orders
WHERE user_id = 123        -- ç­‰ä¾¡æ¡ä»¶ï¼ˆå…ˆï¼‰
  AND status = 'pending'   -- ç­‰ä¾¡æ¡ä»¶ï¼ˆä¸­ï¼‰
ORDER BY created_at DESC;  -- ã‚½ãƒ¼ãƒˆï¼ˆå¾Œï¼‰
```

**Prismaã§ã®è¨­å®š:**

```prisma
model Post {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])  // æ­£ã—ã„é †åº
  @@map("posts")
}
```

## å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³2: Covering Indexã‚’ä½¿ã‚ãªã„

### ã‚ˆãã‚ã‚‹é–“é•ã„

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ã‚‚ã€ã‚¯ã‚¨ãƒªãŒé…ã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
CREATE INDEX idx_users_email ON users(email);

-- æ¤œç´¢å®Ÿè¡Œ
SELECT id, email, username FROM users WHERE email = 'user@example.com';

-- å®Ÿè¡Œãƒ—ãƒ©ãƒ³
-- Index Scan using idx_users_email â†’ Heap Fetchï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç™ºç”Ÿï¼‰
-- ã‚¯ã‚¨ãƒªæ™‚é–“: 45ms
```

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ `email` ã‚’è¦‹ã¤ã‘ãŸå¾Œã€`id` ã¨ `username` ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«**ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆHeap Fetchï¼‰ãŒç™ºç”Ÿ**ã—ã¦ã„ã¾ã™ã€‚

### Covering Indexã§è§£æ±º

**Covering Index**ã¨ã¯ã€ã‚¯ã‚¨ãƒªã«å¿…è¦ãªã™ã¹ã¦ã®ã‚«ãƒ©ãƒ ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã‚ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Œå…¨ã«å›žé¿ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚

```sql
-- âœ… Covering Indexï¼ˆå¿…è¦ãªã‚«ãƒ©ãƒ ã‚’ã™ã¹ã¦å«ã‚ã‚‹ï¼‰
CREATE INDEX idx_users_email_covering ON users(email, id, username);

-- æ¤œç´¢å®Ÿè¡Œ
SELECT id, email, username FROM users WHERE email = 'user@example.com';

-- å®Ÿè¡Œãƒ—ãƒ©ãƒ³
-- Index Only Scan using idx_users_email_covering
-- Heap Fetches: 0ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
-- ã‚¯ã‚¨ãƒªæ™‚é–“: 2msï¼ˆ-96%æ”¹å–„ï¼‰
```

### å®Ÿè¡Œãƒ—ãƒ©ãƒ³ã§ç¢ºèª

```sql
-- Before: Heap Fetchã‚ã‚Š
EXPLAIN ANALYZE
SELECT id, email, username FROM users WHERE email = 'user@example.com';
-- Index Scan using idx_users_email on users
--   Heap Fetches: 1  â† ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç™ºç”Ÿ

-- After: Heap Fetchãªã—
EXPLAIN ANALYZE
SELECT id, email, username FROM users WHERE email = 'user@example.com';
-- Index Only Scan using idx_users_email_covering on users
--   Heap Fetches: 0  â† ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãªã—
```

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ¯”è¼ƒ:**

| æŒ‡æ¨™ | é€šå¸¸Index | Covering Index | æ”¹å–„çŽ‡ |
|------|-----------|----------------|--------|
| ã‚¯ã‚¨ãƒªæ™‚é–“ | 45ms | 2ms | **-96%** |
| Heap Fetch | 1 | 0 | **-100%** |

:::message alert
Covering Indexã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ãŸã‚ã€é »ç¹ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã«é™å®šã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
:::

## å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³3: N+1å•é¡Œã‚’æ”¾ç½®

### ã‚ˆãã‚ã‚‹é–“é•ã„

ORMã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã€æ°—ã¥ã‹ãªã„ã†ã¡ã«N+1å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚

```typescript
// âŒ N+1å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã‚³ãƒ¼ãƒ‰
const posts = await prisma.post.findMany({ take: 100 });

for (const post of posts) {
  // ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚¯ã‚¨ãƒªãŒç™ºè¡Œã•ã‚Œã‚‹ï¼
  const user = await prisma.user.findUnique({
    where: { id: post.userId }
  });
  console.log(`${user.name}: ${post.title}`);
}

// ç™ºè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªæ•°: 1 + 100 = 101ã‚¯ã‚¨ãƒª
// å®Ÿè¡Œæ™‚é–“: 850ms
```

100ä»¶ã®æŠ•ç¨¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€**101å›žã®ã‚¯ã‚¨ãƒª**ãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚

### Eager Loadingï¼ˆäº‹å‰èª­ã¿è¾¼ã¿ï¼‰ã§è§£æ±º

```typescript
// âœ… includeã§ä¸€æ‹¬å–å¾—
const posts = await prisma.post.findMany({
  take: 100,
  include: {
    user: {
      select: {
        id: true,
        name: true
      }
    }
  }
});

for (const post of posts) {
  console.log(`${post.user.name}: ${post.title}`);
}

// ç™ºè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªæ•°: 2ã‚¯ã‚¨ãƒªï¼ˆposts + usersï¼‰
// å®Ÿè¡Œæ™‚é–“: 12msï¼ˆ-99%æ”¹å–„ï¼‰
```

### SQLãƒ¬ãƒ™ãƒ«ã§ã®è§£æ±º

```sql
-- âŒ N+1å•é¡Œï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§100å›žå®Ÿè¡Œï¼‰
SELECT * FROM posts LIMIT 100;
SELECT * FROM users WHERE id = 1;
SELECT * FROM users WHERE id = 2;
-- ... 100å›žç¹°ã‚Šè¿”ã—

-- âœ… JOINã§ä¸€æ‹¬å–å¾—
SELECT p.*, u.name as user_name
FROM posts p
INNER JOIN users u ON p.user_id = u.id
LIMIT 100;
-- 1ã‚¯ã‚¨ãƒªã§å®Œäº†
```

### N+1å•é¡Œã®æ¤œå‡ºæ–¹æ³•

é–‹ç™ºç’°å¢ƒã§ã‚¯ã‚¨ãƒªãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã—ã¦ã€åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¯ã‚¨ãƒªãŒå¤§é‡ã«ç™ºè¡Œã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```typescript
// Prismaã§ã‚¯ã‚¨ãƒªãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
```

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ¯”è¼ƒ:**

| æŒ‡æ¨™ | N+1å•é¡Œã‚ã‚Š | è§£æ±ºå¾Œ | æ”¹å–„çŽ‡ |
|------|-------------|--------|--------|
| ã‚¯ã‚¨ãƒªæ•° | 101 | 2 | **-98%** |
| å®Ÿè¡Œæ™‚é–“ | 850ms | 12ms | **-99%** |

## ã¾ã¨ã‚

| å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ | åŽŸå›  | è§£æ±ºç­– | æ”¹å–„åŠ¹æžœ |
|--------------|------|--------|----------|
| è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é †åºãƒŸã‚¹ | å·¦ç«¯å„ªå…ˆãƒ«ãƒ¼ãƒ«ã‚’çŸ¥ã‚‰ãªã„ | ç­‰ä¾¡æ¡ä»¶ã‚’å…ˆã€ç¯„å›²æ¡ä»¶ã‚’å¾Œã« | **-99.6%** |
| Covering Indexæœªä½¿ç”¨ | Heap Fetchã®å­˜åœ¨ã‚’çŸ¥ã‚‰ãªã„ | å¿…è¦ã‚«ãƒ©ãƒ ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã‚ã‚‹ | **-96%** |
| N+1å•é¡Œ | ORMã®å‹•ä½œã‚’ç†è§£ã—ã¦ã„ãªã„ | Eager Loadingã§ä¸€æ‹¬å–å¾— | **-99%** |

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã¯ã€æ­£ã—ãç†è§£ã™ã‚Œã°**åŠ‡çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ”¹å–„**ãŒå¯èƒ½ã§ã™ã€‚ã¾ãšã¯ `EXPLAIN ANALYZE` ã§ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªã™ã‚‹ç¿’æ…£ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚

:::message
ã‚ˆã‚Šè©³ã—ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ï¼ˆéƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€å¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã©ï¼‰ã‚„ã€æ­£è¦åŒ–ç†è«–ã€ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã€Prisma/TypeORMå®Ÿè·µã«ã¤ã„ã¦ã¯ã€æ›¸ç±ã€Œ[Databaseè¨­è¨ˆå®Œå…¨ã‚¬ã‚¤ãƒ‰ 2026](https://zenn.dev/gaku52/books/database-design-complete-guide-2026)ã€ã§è©³ã—ãè§£èª¬ã—ã¦ã„ã¾ã™ã€‚
:::

## å‚è€ƒãƒªãƒ³ã‚¯

- [PostgreSQLå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹](https://www.postgresql.org/docs/current/indexes.html)
- [MySQLå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–](https://dev.mysql.com/doc/refman/8.0/en/optimization-indexes.html)
- [Prismaå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹](https://www.prisma.io/docs/orm/prisma-schema/data-model/indexes)
